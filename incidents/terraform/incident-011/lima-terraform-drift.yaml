arch: "aarch64"
images:
  - location: "https://cloud-images.ubuntu.com/releases/22.04/release/ubuntu-22.04-server-cloudimg-arm64.img"
    arch: "aarch64"
cpus: 2
memory: "2GiB"
disk: "20GiB"

provision:
  - mode: system
    script: |
      #!/bin/bash
      set -eux -o pipefail
      
      hostnamectl set-hostname terraform-drift
      apt-get update
      apt-get install -y wget unzip
      
      # Install Terraform
      TERRAFORM_VERSION="1.7.0"
      wget -q https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_arm64.zip
      unzip -q terraform_${TERRAFORM_VERSION}_linux_arm64.zip
      mv terraform /usr/local/bin/
      rm terraform_${TERRAFORM_VERSION}_linux_arm64.zip
      
      LIMA_USER=$(stat -c '%U:%G' /home/*)
      
      mkdir -p /opt/terraform /tmp/managed-resources
      chown -R $LIMA_USER /opt/terraform /tmp/managed-resources
      cd /opt/terraform
      
      echo 'resource "local_file" "config" {' > main.tf
      echo '  filename = "/tmp/managed-resources/app-config.json"' >> main.tf
      echo '  content  = jsonencode({' >> main.tf
      echo '    app_name = "production-api"' >> main.tf
      echo '    version  = "1.0.0"' >> main.tf
      echo '    replicas = 3' >> main.tf
      echo '    enabled  = true' >> main.tf
      echo '  })' >> main.tf
      echo '}' >> main.tf
      echo '' >> main.tf
      echo 'resource "local_file" "database" {' >> main.tf
      echo '  filename = "/tmp/managed-resources/database.conf"' >> main.tf
      echo '  content  = <<-EOT' >> main.tf
      echo '    host=db.example.com' >> main.tf
      echo '    port=5432' >> main.tf
      echo '    database=production' >> main.tf
      echo '    max_connections=100' >> main.tf
      echo '  EOT' >> main.tf
      echo '}' >> main.tf
      
      terraform init
      terraform apply -auto-approve
      
      echo '{"app_name":"production-api","version":"2.0.0","replicas":5,"enabled":true}' > /tmp/managed-resources/app-config.json
      sed -i 's/max_connections=100/max_connections=50/' /tmp/managed-resources/database.conf
      
      echo "Drift scenario created - check /opt/terraform"

