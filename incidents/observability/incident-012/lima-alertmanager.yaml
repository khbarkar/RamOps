arch: "aarch64"
images:
  - location: "https://cloud-images.ubuntu.com/releases/22.04/release/ubuntu-22.04-server-cloudimg-arm64.img"
    arch: "aarch64"
cpus: 2
memory: "4GiB"
disk: "20GiB"

provision:
  - mode: system
    script: |
      #!/bin/bash
      set -eux -o pipefail
      
      hostnamectl set-hostname alertmanager
      apt-get update
      apt-get install -y wget curl postgresql
      
      # Install Prometheus
      PROM_VERSION="2.48.0"
      wget -q https://github.com/prometheus/prometheus/releases/download/v${PROM_VERSION}/prometheus-${PROM_VERSION}.linux-arm64.tar.gz
      tar xzf prometheus-${PROM_VERSION}.linux-arm64.tar.gz
      cp prometheus-${PROM_VERSION}.linux-arm64/prometheus /usr/local/bin/
      cp prometheus-${PROM_VERSION}.linux-arm64/promtool /usr/local/bin/
      mkdir -p /etc/prometheus /var/lib/prometheus
      rm -rf prometheus-${PROM_VERSION}.linux-arm64*
      
      # Install Alertmanager
      AM_VERSION="0.26.0"
      wget -q https://github.com/prometheus/alertmanager/releases/download/v${AM_VERSION}/alertmanager-${AM_VERSION}.linux-arm64.tar.gz
      tar xzf alertmanager-${AM_VERSION}.linux-arm64.tar.gz
      cp alertmanager-${AM_VERSION}.linux-arm64/alertmanager /usr/local/bin/
      cp alertmanager-${AM_VERSION}.linux-arm64/amtool /usr/local/bin/
      mkdir -p /etc/alertmanager /var/lib/alertmanager
      rm -rf alertmanager-${AM_VERSION}.linux-arm64*
      
      # Configure Prometheus with alert rules
      cat > /etc/prometheus/prometheus.yml << 'PROMEOF'
      global:
        scrape_interval: 5s
        evaluation_interval: 5s
      
      alerting:
        alertmanagers:
          - static_configs:
              - targets: ['localhost:9093']
      
      rule_files:
        - /etc/prometheus/alert.rules.yml
      
      scrape_configs:
        - job_name: 'prometheus'
          static_configs:
            - targets: ['localhost:9090']
        - job_name: 'node'
          static_configs:
            - targets: ['localhost:9100']
      PROMEOF
      
      # Create alert rules - multiple cascading alerts from one root cause
      cat > /etc/prometheus/alert.rules.yml << 'RULEEOF'
      groups:
        - name: infrastructure
          interval: 5s
          rules:
            # Root cause alert - fires when disk has less than 3GB free
            - alert: DatabaseDiskFull
              expr: node_filesystem_avail_bytes{mountpoint="/"} < 3000000000
              for: 10s
              labels:
                severity: critical
                component: database
                type: root_cause
              annotations:
                summary: "Database disk is full"
            
            # Symptom alerts (cascade from disk full)
            - alert: DatabaseConnectionFailed
              expr: node_filesystem_avail_bytes{mountpoint="/"} < 3000000000
              for: 5s
              labels:
                severity: critical
                component: database
                type: symptom
              annotations:
                summary: "Cannot connect to database"
            
            - alert: APILatencyHigh
              expr: node_filesystem_avail_bytes{mountpoint="/"} < 3000000000
              for: 5s
              labels:
                severity: warning
                component: api
                type: symptom
              annotations:
                summary: "API response time > 5s"
            
            - alert: CacheMissRateHigh
              expr: node_filesystem_avail_bytes{mountpoint="/"} < 3000000000
              for: 5s
              labels:
                severity: warning
                component: cache
                type: symptom
              annotations:
                summary: "Cache miss rate elevated to 95%"
            
            - alert: QueueBacklogGrowing
              expr: node_filesystem_avail_bytes{mountpoint="/"} < 3000000000
              for: 5s
              labels:
                severity: warning
                component: queue
                type: symptom
              annotations:
                summary: "Message queue backlog growing"
            
            - alert: ErrorRateSpike
              expr: node_filesystem_avail_bytes{mountpoint="/"} < 3000000000
              for: 5s
              labels:
                severity: critical
                component: api
                type: symptom
              annotations:
                summary: "Error rate spiked to 45%"
            
            - alert: MemoryPressure
              expr: node_filesystem_avail_bytes{mountpoint="/"} < 3000000000
              for: 5s
              labels:
                severity: warning
                component: app
                type: symptom
              annotations:
                summary: "Application memory usage high"
            
            - alert: CPUThrottling
              expr: node_filesystem_avail_bytes{mountpoint="/"} < 3000000000
              for: 5s
              labels:
                severity: warning
                component: app
                type: symptom
              annotations:
                summary: "CPU throttling detected"
      RULEEOF
      
      # Install and configure node_exporter for filesystem metrics
      NODE_EXP_VERSION="1.7.0"
      wget -q https://github.com/prometheus/node_exporter/releases/download/v${NODE_EXP_VERSION}/node_exporter-${NODE_EXP_VERSION}.linux-arm64.tar.gz
      tar xzf node_exporter-${NODE_EXP_VERSION}.linux-arm64.tar.gz
      cp node_exporter-${NODE_EXP_VERSION}.linux-arm64/node_exporter /usr/local/bin/
      rm -rf node_exporter-${NODE_EXP_VERSION}.linux-arm64*
      
      cat > /etc/systemd/system/node_exporter.service << 'NODEEOF'
      [Unit]
      Description=Node Exporter
      After=network.target
      
      [Service]
      Type=simple
      ExecStart=/usr/local/bin/node_exporter
      Restart=always
      
      [Install]
      WantedBy=multi-user.target
      NODEEOF
      
      systemctl daemon-reload
      systemctl enable node_exporter
      systemctl start node_exporter
      
      # Wait for node_exporter to start
      sleep 5
      
      # Configure Alertmanager
      cat > /etc/alertmanager/alertmanager.yml << 'AMEOF'
      global:
        resolve_timeout: 5m
      
      route:
        receiver: 'default'
        group_wait: 1s
        group_interval: 1s
        repeat_interval: 5m
      
      receivers:
        - name: 'default'
      AMEOF
      
      # Create systemd services
      cat > /etc/systemd/system/prometheus.service << 'PROMSVC'
      [Unit]
      Description=Prometheus
      After=network.target
      
      [Service]
      Type=simple
      ExecStart=/usr/local/bin/prometheus --config.file=/etc/prometheus/prometheus.yml --storage.tsdb.path=/var/lib/prometheus
      Restart=always
      
      [Install]
      WantedBy=multi-user.target
      PROMSVC
      
      cat > /etc/systemd/system/alertmanager.service << 'AMSVC'
      [Unit]
      Description=Alertmanager
      After=network.target
      
      [Service]
      Type=simple
      ExecStart=/usr/local/bin/alertmanager --config.file=/etc/alertmanager/alertmanager.yml --storage.path=/var/lib/alertmanager
      Restart=always
      
      [Install]
      WantedBy=multi-user.target
      AMSVC
      
      systemctl daemon-reload
      systemctl enable prometheus alertmanager
      systemctl start prometheus alertmanager
      
      # Fill disk to trigger alerts (leave ~15% free to trigger < 20% condition)
      dd if=/dev/zero of=/var/fillfile bs=1M count=15000 2>/dev/null || true
      
      echo "Monitoring stack provisioned - disk filled to trigger alert storm"

portForwards:
  - guestPort: 9090
    hostPort: 9090
  - guestPort: 9093
    hostPort: 9093
