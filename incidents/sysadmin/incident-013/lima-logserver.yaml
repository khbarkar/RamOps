arch: "aarch64"
images:
  - location: "https://cloud-images.ubuntu.com/releases/22.04/release/ubuntu-22.04-server-cloudimg-arm64.img"
    arch: "aarch64"
cpus: 1
memory: "1GiB"
disk: "10GiB"

mounts:
  - location: "~"
    writable: false
  - location: "/tmp/lima"
    writable: true

provision:
  - mode: system
    script: |
      #!/bin/bash
      set -eux -o pipefail
      hostnamectl set-hostname logserver
      apt-get update
      apt-get install -y python3 lsof
      
      # Create separate filesystem for logs (simulating /var/log on separate partition)
      mkdir -p /mnt/logs
      dd if=/dev/zero of=/opt/logs.img bs=1M count=2048
      mkfs.ext4 -F /opt/logs.img
      mount -o loop /opt/logs.img /mnt/logs
      echo '/opt/logs.img /mnt/logs ext4 loop 0 0' >> /etc/fstab
      
      mkdir -p /mnt/logs/webapp
      chown -R ubuntu:ubuntu /mnt/logs/webapp
      
      # Create app directory on main filesystem
      mkdir -p /opt/webapp
      chown -R ubuntu:ubuntu /opt/webapp
      
      cat > /opt/webapp/app.py << 'EOF'
      import time
      import random
      
      # Open the log file that will be rotated
      log_file = open('/mnt/logs/webapp/app.log', 'a')
      
      while True:
          log_file.write(f"{time.time()} - Request processed - Status: {random.choice([200, 404, 500])}\n")
          log_file.flush()
          time.sleep(0.01)
      EOF
      
      printf '%s\n' '[Unit]' 'Description=Web App Logger' 'After=network.target' '' '[Service]' 'Type=simple' 'User=ubuntu' 'WorkingDirectory=/opt/webapp' 'ExecStart=/usr/bin/python3 /opt/webapp/app.py' 'Restart=always' '' '[Install]' 'WantedBy=multi-user.target' > /etc/systemd/system/webapp.service
      
      systemctl daemon-reload
      systemctl enable webapp.service
      systemctl start webapp.service
      
      sleep 5
      
      # Fill the log file that the app has open (fill to 100%)
      dd if=/dev/zero of=/mnt/logs/webapp/app.log bs=1M count=1950 2>/dev/null || true
      
      # Simulate log rotation - move the file the app has open
      mv /mnt/logs/webapp/app.log /mnt/logs/webapp/app-old-$(date +%s).log
      touch /mnt/logs/webapp/app.log
      chown ubuntu:ubuntu /mnt/logs/webapp/app.log
      
      sleep 2
      
      # Delete old logs (but space not freed because app still has it open)
      rm /mnt/logs/webapp/app-old-*.log
      
      echo "Disk space issue created - webapp has deleted file open"

portForwards: []
