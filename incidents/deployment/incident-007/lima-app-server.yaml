name: app-server
arch: "aarch64"
images:
  - location: "https://cloud-images.ubuntu.com/releases/22.04/release/ubuntu-22.04-server-cloudimg-arm64.img"
    arch: "aarch64"
cpus: 1
memory: "1GiB"
disk: "10GiB"

provision:
  - mode: system
    script: |
      #!/bin/bash
      set -eux -o pipefail
      
      hostnamectl set-hostname app-server
      apt-get update
      apt-get install -y python3 python3-pip
      
      # Create app directory
      mkdir -p /opt/app/{releases,current}
      
      # Create sample app
      cat > /opt/app/app.py <<'EOF'
from http.server import HTTPServer, BaseHTTPRequestHandler
import json

class Handler(BaseHTTPRequestHandler):
    def do_GET(self):
        self.send_response(200)
        self.send_header('Content-type', 'application/json')
        self.end_headers()
        self.wfile.write(json.dumps({"status": "ok", "version": "1.0"}).encode())

HTTPServer(('', 8000), Handler).serve_forever()
EOF
      
      # Create systemd service
      cat > /etc/systemd/system/app.service <<'EOF'
[Unit]
Description=Sample App
After=network.target

[Service]
Type=simple
WorkingDirectory=/opt/app/current
ExecStart=/usr/bin/python3 /opt/app/current/app.py
Restart=always

[Install]
WantedBy=multi-user.target
EOF
      
      systemctl daemon-reload
      
      echo "App server provisioned"

portForwards:
  - guestPort: 8000
    hostPort: 8000
