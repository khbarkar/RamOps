arch: "aarch64"
images:
  - location: "https://cloud-images.ubuntu.com/releases/22.04/release/ubuntu-22.04-server-cloudimg-arm64.img"
    arch: "aarch64"
cpus: 1
memory: "1GiB"
disk: "10GiB"

provision:
  - mode: system
    script: |
      #!/bin/bash
      set -eux -o pipefail
      hostnamectl set-hostname app-server
      apt-get update
      apt-get install -y python3
      
      mkdir -p /opt/app /opt/configs
      
      echo '{"version": "1.0.0", "feature_x": false}' > /opt/configs/config.v1.json
      echo '{"version": "2.0.0", "feature_x": true, BROKEN}' > /opt/configs/config.v2.json
      
      ln /opt/configs/config.v1.json /opt/app/config.json
      
      cat > /opt/app/app.py << 'APPEOF'
      from http.server import HTTPServer, BaseHTTPRequestHandler
      import json
      import sys
      
      try:
          with open('/opt/app/config.json') as f:
              config = json.load(f)
          print(f"Loaded config: {config}")
      except Exception as e:
          print(f"ERROR loading config: {e}")
          sys.exit(1)
      
      class Handler(BaseHTTPRequestHandler):
          def do_GET(self):
              self.send_response(200)
              self.send_header('Content-type', 'application/json')
              self.end_headers()
              self.wfile.write(json.dumps(config).encode())
      
      HTTPServer(('', 8000), Handler).serve_forever()
      APPEOF
      
      printf '%s\n' '[Unit]' 'Description=Sample App' 'After=network.target' '' '[Service]' 'Type=simple' 'WorkingDirectory=/opt/app' 'ExecStart=/usr/bin/python3 /opt/app/app.py' 'Restart=on-failure' 'RestartSec=5' '' '[Install]' 'WantedBy=multi-user.target' > /etc/systemd/system/app.service
      
      systemctl daemon-reload
      systemctl enable app.service
      
      ln -f /opt/configs/config.v2.json /opt/app/config.json
      
      echo "Hard link trap deployed"

portForwards:
  - guestPort: 8000
    hostPort: 8000
