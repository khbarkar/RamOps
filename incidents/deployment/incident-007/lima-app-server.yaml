arch: "aarch64"
images:
  - location: "https://cloud-images.ubuntu.com/releases/22.04/release/ubuntu-22.04-server-cloudimg-arm64.img"
    arch: "aarch64"
cpus: 1
memory: "1GiB"
disk: "10GiB"

provision:
  - mode: system
    script: |
      #!/bin/bash
      set -eux -o pipefail
      hostnamectl set-hostname app-server
      apt-get update
      apt-get install -y python3
      mkdir -p /opt/app/releases /opt/app/current
      echo 'from http.server import HTTPServer, BaseHTTPRequestHandler' > /opt/app/app.py
      echo 'import json' >> /opt/app/app.py
      echo 'class Handler(BaseHTTPRequestHandler):' >> /opt/app/app.py
      echo '    def do_GET(self):' >> /opt/app/app.py
      echo '        self.send_response(200)' >> /opt/app/app.py
      echo '        self.send_header("Content-type", "application/json")' >> /opt/app/app.py
      echo '        self.end_headers()' >> /opt/app/app.py
      echo '        self.wfile.write(json.dumps({"status": "ok", "version": "1.0"}).encode())' >> /opt/app/app.py
      echo 'HTTPServer(("", 8000), Handler).serve_forever()' >> /opt/app/app.py
      printf '%s\n' '[Unit]' 'Description=Sample App' 'After=network.target' '' '[Service]' 'Type=simple' 'WorkingDirectory=/opt/app/current' 'ExecStart=/usr/bin/python3 /opt/app/current/app.py' 'Restart=always' '' '[Install]' 'WantedBy=multi-user.target' > /etc/systemd/system/app.service
      systemctl daemon-reload
      echo "App server provisioned"

portForwards:
  - guestPort: 8000
    hostPort: 8000
