Vagrant.configure("2") do |config|
  # Use ARM-compatible box for ARM systems, x86 box for Intel
  if `uname -m`.strip == "arm64"
    config.vm.box = "perk/ubuntu-2204-arm64"  # ARM64 box
  else
    config.vm.box = "bento/ubuntu-22.04"  # x86_64 box
  end

  # Kafka Broker 1
  config.vm.define "kafka1" do |broker|
    broker.vm.hostname = "kafka1"
    broker.vm.network "private_network", ip: "192.168.56.11"

    # QEMU provider (ARM-compatible, free)
    broker.vm.provider "qemu" do |qe|
      qe.memory = "2048"
      qe.cpus = 2
      qe.ssh_port = 50022
      qe.arch = "aarch64"
      qe.machine = "virt,accel=hvf,highmem=off"
      qe.cpu = "cortex-a72"
      qe.net_device = "virtio-net-pci"
    end

    broker.vm.provider "virtualbox" do |vb|
      vb.memory = "2048"
      vb.cpus = 2
      vb.name = "ramops-kafka1"

      # Create a slow disk (10MB/s write limit) to simulate I/O bottleneck
      unless File.exist?("./slow-disk-1.vdi")
        vb.customize ['createmedium', 'disk', '--filename', './slow-disk-1.vdi', '--size', 10240]
      end
      vb.customize ['storageattach', :id, '--storagectl', 'SCSI', '--port', 2, '--device', 0, '--type', 'hdd', '--medium', './slow-disk-1.vdi']
    end

    broker.vm.provider "vmware_desktop" do |v|
      v.vmx["memsize"] = "2048"
      v.vmx["numvcpus"] = "2"
      # Note: VMware doesn't support the same disk throttling, so we'll use cgroup limits in provision script
    end

    broker.vm.provision "shell", path: "scripts/provision-broker.sh", args: ["1", "192.168.56.11"]
  end

  # Kafka Broker 2
  config.vm.define "kafka2" do |broker|
    broker.vm.hostname = "kafka2"
    broker.vm.network "private_network", ip: "192.168.56.12"

    broker.vm.provider "virtualbox" do |vb|
      vb.memory = "2048"
      vb.cpus = 2
      vb.name = "ramops-kafka2"

      unless File.exist?("./slow-disk-2.vdi")
        vb.customize ['createmedium', 'disk', '--filename', './slow-disk-2.vdi', '--size', 10240]
      end
      vb.customize ['storageattach', :id, '--storagectl', 'SCSI', '--port', 2, '--device', 0, '--type', 'hdd', '--medium', './slow-disk-2.vdi']
    end

    broker.vm.provider "vmware_desktop" do |v|
      v.vmx["memsize"] = "2048"
      v.vmx["numvcpus"] = "2"
    end

    broker.vm.provision "shell", path: "scripts/provision-broker.sh", args: ["2", "192.168.56.12"]
  end

  # Kafka Broker 3
  config.vm.define "kafka3" do |broker|
    broker.vm.hostname = "kafka3"
    broker.vm.network "private_network", ip: "192.168.56.13"

    broker.vm.provider "virtualbox" do |vb|
      vb.memory = "2048"
      vb.cpus = 2
      vb.name = "ramops-kafka3"

      unless File.exist?("./slow-disk-3.vdi")
        vb.customize ['createmedium', 'disk', '--filename', './slow-disk-3.vdi', '--size', 10240]
      end
      vb.customize ['storageattach', :id, '--storagectl', 'SCSI', '--port', 2, '--device', 0, '--type', 'hdd', '--medium', './slow-disk-3.vdi']
    end

    broker.vm.provider "vmware_desktop" do |v|
      v.vmx["memsize"] = "2048"
      v.vmx["numvcpus"] = "2"
    end

    broker.vm.provision "shell", path: "scripts/provision-broker.sh", args: ["3", "192.168.56.13"]
  end

  # Monitoring VM (Prometheus + Grafana)
  config.vm.define "monitoring" do |mon|
    mon.vm.hostname = "monitoring"
    mon.vm.network "private_network", ip: "192.168.56.20"
    mon.vm.network "forwarded_port", guest: 3000, host: 3000  # Grafana
    mon.vm.network "forwarded_port", guest: 9090, host: 9090  # Prometheus

    mon.vm.provider "virtualbox" do |vb|
      vb.memory = "2048"
      vb.cpus = 1
      vb.name = "ramops-monitoring"
    end

    mon.vm.provider "vmware_desktop" do |v|
      v.vmx["memsize"] = "2048"
      v.vmx["numvcpus"] = "1"
    end

    mon.vm.provision "shell", path: "scripts/provision-monitoring.sh"
  end
end
