#!/usr/bin/env bash
# Ram Ops - Interactive TUI for incident scenarios

set -euo pipefail

VERSION="1.0.0"
REPO_URL="https://github.com/khbarkar/openRam"
INSTALL_DIR="$HOME/.ramops"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
GRAY='\033[0;90m'
NC='\033[0m' # No Color
BOLD='\033[1m'

# Logo
show_logo() {
  clear
  echo -e "${RED}"
  cat << 'EOF'
    ____                   ____            
   / __ \____ _____ ___   / __ \____  _____
  / /_/ / __ `/ __ `__ \ / / / / __ \/ ___/
 / _, _/ /_/ / / / / / // /_/ / /_/ (__  ) 
/_/ |_|\__,_/_/ /_/ /_/ \____/ .___/____/  
                            /_/            
EOF
  echo -e "${NC}"
  echo -e "${GRAY}Incident Training for Kubernetes & Cloud Infrastructure${NC}"
  echo -e "${GRAY}Version $VERSION${NC}"
  echo ""
}

# Check dependencies
check_deps() {
  local missing=()
  
  if ! command -v git &> /dev/null; then
    missing+=("git")
  fi
  
  if ! command -v limactl &> /dev/null && ! command -v vagrant &> /dev/null; then
    missing+=("lima or vagrant")
  fi
  
  if [ ${#missing[@]} -gt 0 ]; then
    echo -e "${RED}Missing dependencies: ${missing[*]}${NC}"
    echo ""
    echo "Install with:"
    echo "  brew install ${missing[*]}"
    exit 1
  fi
}

# Clone or update repo
setup_repo() {
  if [ ! -d "$INSTALL_DIR" ]; then
    echo -e "${CYAN}Cloning Ram Ops repository...${NC}"
    git clone "$REPO_URL" "$INSTALL_DIR" --quiet
  else
    echo -e "${CYAN}Updating Ram Ops repository...${NC}"
    cd "$INSTALL_DIR"
    git pull --quiet
  fi
}

# List incidents
list_incidents() {
  local incidents=(
    "kubernetes/incident-001:Production pod crash-looping:Beginner:kind"
    "kubernetes/incident-002:Node goes NotReady:Beginner:kind"
    "kubernetes/incident-003:DNS outage:Intermediate:kind"
    "kubernetes/incident-004:Storage volume full:Beginner-Intermediate:kind"
    "kubernetes/incident-008:HTTPS certificate errors:Intermediate:kind"
    "kubernetes/incident-009:Memory leak in production:Intermediate:kind"
    "kubernetes/incident-010:Exposed database credentials:Beginner-Intermediate:kind"
    "kafka/incident-005:Kafka disk-bound brokers:Intermediate:lima"
    "kafka/incident-006:Kafka network-bound brokers:Intermediate-Advanced:lima"
    "deployment/incident-007:Hard link deployment trap:Intermediate-Advanced:lima"
    "terraform/incident-011:Infrastructure drift detection:Intermediate:lima"
    "observability/incident-012:Alert storm from single root cause:Intermediate-Advanced:lima"
  )
  
  echo "${incidents[@]}"
}

# Draw menu
draw_menu() {
  local selected=$1
  local incidents=($(list_incidents))
  
  show_logo
  
  echo -e "${WHITE}${BOLD}SELECT AN INCIDENT${NC}"
  echo ""
  
  for i in "${!incidents[@]}"; do
    IFS=':' read -r path title difficulty vm_type <<< "${incidents[$i]}"
    local num=$((i + 1))
    
    if [ $i -eq $selected ]; then
      echo -e "${GREEN}▶ ${BOLD}$num. $title${NC} ${GRAY}[$difficulty]${NC}"
    else
      echo -e "  ${GRAY}$num.${NC} $title ${GRAY}[$difficulty]${NC}"
    fi
  done
  
  echo ""
  echo -e "${GRAY}────────────────────────────────────────────────────────${NC}"
  echo -e "${CYAN}↑/↓${NC} Navigate  ${CYAN}Enter${NC} Select  ${CYAN}q${NC} Quit"
}

# Draw action menu
draw_action_menu() {
  local selected=$1
  local incident_path=$2
  local incident_title=$3
  
  show_logo
  
  echo -e "${WHITE}${BOLD}$incident_title${NC}"
  echo -e "${GRAY}$incident_path${NC}"
  echo ""
  
  local actions=("Setup" "Verify" "Teardown" "View README" "Back")
  
  for i in "${!actions[@]}"; do
    if [ $i -eq $selected ]; then
      echo -e "${GREEN}▶ ${BOLD}${actions[$i]}${NC}"
    else
      echo -e "  ${GRAY}${actions[$i]}${NC}"
    fi
  done
  
  echo ""
  echo -e "${GRAY}────────────────────────────────────────────────────────${NC}"
  echo -e "${CYAN}↑/↓${NC} Navigate  ${CYAN}Enter${NC} Select  ${CYAN}q${NC} Back"
}

# Run action
run_action() {
  local action=$1
  local incident_path=$2
  local vm_type=$3
  
  cd "$INSTALL_DIR/incidents/$incident_path"
  
  case $action in
    0) # Setup
      if [ "$vm_type" = "lima" ] && [ -f "setup-lima.sh" ]; then
        ./setup-lima.sh
      else
        ./setup.sh
      fi
      ;;
    1) # Verify
      if [ "$vm_type" = "lima" ] && [ -f "verify-lima.sh" ]; then
        ./verify-lima.sh
      else
        ./verify.sh
      fi
      ;;
    2) # Teardown
      if [ "$vm_type" = "lima" ] && [ -f "teardown-lima.sh" ]; then
        ./teardown-lima.sh
      else
        ./teardown.sh
      fi
      ;;
    3) # View README
      if command -v bat &> /dev/null; then
        bat README.md
      elif command -v less &> /dev/null; then
        less README.md
      else
        cat README.md
      fi
      ;;
  esac
  
  echo ""
  echo -e "${CYAN}Press any key to continue...${NC}"
  read -n 1 -s
}

# Action menu loop
action_menu() {
  local incident_path=$1
  local incident_title=$2
  local vm_type=$3
  local selected=0
  local max_items=4
  
  while true; do
    draw_action_menu $selected "$incident_path" "$incident_title"
    
    read -rsn1 key
    case $key in
      $'\x1b')
        read -rsn2 -t 0.1 key
        case $key in
          '[A') # Up
            ((selected--))
            [ $selected -lt 0 ] && selected=$max_items
            ;;
          '[B') # Down
            ((selected++))
            [ $selected -gt $max_items ] && selected=0
            ;;
        esac
        ;;
      '') # Enter
        if [ $selected -eq 4 ]; then
          return
        fi
        clear
        run_action $selected "$incident_path" "$vm_type"
        ;;
      'q'|'Q')
        return
        ;;
    esac
  done
}

# Main menu loop
main_menu() {
  local selected=0
  local incidents=($(list_incidents))
  local max_items=$((${#incidents[@]} - 1))
  
  while true; do
    draw_menu $selected
    
    read -rsn1 key
    case $key in
      $'\x1b')
        read -rsn2 -t 0.1 key
        case $key in
          '[A') # Up
            ((selected--))
            [ $selected -lt 0 ] && selected=$max_items
            ;;
          '[B') # Down
            ((selected++))
            [ $selected -gt $max_items ] && selected=0
            ;;
        esac
        ;;
      '') # Enter
        IFS=':' read -r path title difficulty vm_type <<< "${incidents[$selected]}"
        action_menu "$path" "$title" "$vm_type"
        ;;
      'q'|'Q')
        clear
        echo -e "${GREEN}Thanks for using Ram Ops!${NC}"
        exit 0
        ;;
    esac
  done
}

# Main
main() {
  check_deps
  setup_repo
  main_menu
}

main
