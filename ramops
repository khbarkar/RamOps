#!/usr/bin/env bash
# Ram Ops - Interactive TUI for incident scenarios

set -euo pipefail

VERSION="1.0.0"
REPO_URL="https://github.com/khbarkar/openRam"
INSTALL_DIR="$HOME/.ramops"

# Colors - Orange on Black theme
ORANGE='\033[38;5;208m'
DARK_ORANGE='\033[38;5;166m'
LIGHT_ORANGE='\033[38;5;214m'
BLACK='\033[0;30m'
GRAY='\033[38;5;240m'
WHITE='\033[1;37m'
NC='\033[0m'
BOLD='\033[1m'
DIM='\033[2m'

# Logo
show_logo() {
  clear
  echo -e "${ORANGE}"
  cat << 'EOF'


██████╗  █████╗ ███╗   ███╗ ██████╗ ██████╗ ███████╗
██╔══██╗██╔══██╗████╗ ████║██╔═══██╗██╔══██╗██╔════╝
██████╔╝███████║██╔████╔██║██║   ██║██████╔╝███████╗
██╔══██╗██╔══██║██║╚██╔╝██║██║   ██║██╔═══╝ ╚════██║
██║  ██║██║  ██║██║ ╚═╝ ██║╚██████╔╝██║     ███████║
╚═╝  ╚═╝╚═╝  ╚═╝╚═╝     ╚═╝ ╚═════╝ ╚═╝     ╚══════╝

EOF
  echo -e "${NC}"
  echo -e "${GRAY}Incident Training for Kubernetes & Cloud Infrastructure${NC}"
  echo ""
}

# Check dependencies
check_deps() {
  if ! command -v git &> /dev/null; then
    clear
    echo -e "${ORANGE}Git is required but not installed.${NC}"
    echo ""
    echo "Install with:"
    echo "  brew install git"
    exit 1
  fi
}

# Clone or update repo
setup_repo() {
  if [ ! -d "$INSTALL_DIR" ]; then
    echo -e "${GRAY}Cloning Ram Ops repository...${NC}"
    git clone "$REPO_URL" "$INSTALL_DIR" --quiet
  else
    cd "$INSTALL_DIR"
    # Check for updates only if we haven't checked recently
    local last_check_file="$INSTALL_DIR/.last_update_check"
    local current_time=$(date +%s)
    local check_interval=86400  # 24 hours
    
    if [ -f "$last_check_file" ]; then
      local last_check=$(cat "$last_check_file")
      local time_diff=$((current_time - last_check))
      if [ $time_diff -lt $check_interval ]; then
        return
      fi
    fi
    
    # Fetch and compare
    git fetch --quiet 2>/dev/null || true
    local local_hash=$(git rev-parse HEAD 2>/dev/null)
    local remote_hash=$(git rev-parse @{u} 2>/dev/null)
    
    # Save check time
    echo "$current_time" > "$last_check_file"
    
    if [ "$local_hash" != "$remote_hash" ] && [ -n "$remote_hash" ]; then
      clear
      show_logo
      echo -e "${ORANGE}Updates available!${NC}"
      echo ""
      echo -e "${GRAY}Run 'ramops update' to get the latest scenarios.${NC}"
      echo ""
      echo -e "${GRAY}Press any key to continue...${NC}"
      read -n 1 -s
    fi
  fi
}

# Update command
do_update() {
  clear
  show_logo
  echo -e "${ORANGE}Updating Ram Ops...${NC}"
  echo ""
  
  if [ ! -d "$INSTALL_DIR" ]; then
    echo -e "${ORANGE}Ram Ops not installed. Run 'ramops' first.${NC}"
    exit 1
  fi
  
  cd "$INSTALL_DIR"
  echo -e "${GRAY}Fetching latest changes...${NC}"
  git fetch --quiet
  
  local local_hash=$(git rev-parse HEAD)
  local remote_hash=$(git rev-parse @{u} 2>/dev/null)
  
  if [ "$local_hash" = "$remote_hash" ]; then
    echo ""
    echo -e "${ORANGE}Already up to date!${NC}"
  else
    echo -e "${GRAY}Pulling updates...${NC}"
    git reset --hard origin/main --quiet
    echo ""
    echo -e "${ORANGE}[ok] Ram Ops updated successfully!${NC}"
  fi
  
  exit 0
}

# Get all incidents with full info
get_all_incidents() {
  echo "001:kubernetes:Pod crashloop:Beginner"
  echo "002:kubernetes:Node NotReady:Beginner"
  echo "003:kubernetes:DNS outage:Intermediate"
  echo "004:kubernetes:Storage full:Beginner-Intermediate"
  echo "005:kafka:Disk bound:Intermediate"
  echo "006:kafka:Network bound:Intermediate-Advanced"
  echo "007:deployment:Hard link trap:Intermediate-Advanced"
  echo "008:kubernetes:HTTPS cert error:Intermediate"
  echo "009:kubernetes:Memory leak:Intermediate"
  echo "010:kubernetes:Exposed creds:Beginner-Intermediate"
  echo "011:terraform:Drift detection:Intermediate"
  echo "012:observability:Alert storm:Intermediate-Advanced"
  echo "013:sysadmin:Vanishing logs:Beginner-Intermediate"
  echo "014:sysadmin:Zombie apocalypse:Intermediate-Advanced"
}

# Get incidents by difficulty
get_incidents_by_difficulty() {
  local difficulty=$1
  get_all_incidents | while IFS=':' read -r num tech title diff; do
    if [[ "$diff" == *"$difficulty"* ]]; then
      echo "$num:$tech:$title:$diff"
    fi
  done
}

# Get incidents by technology
get_incidents_by_technology() {
  local tech=$1
  get_all_incidents | while IFS=':' read -r num technology title diff; do
    if [[ "$technology" == "$tech" ]]; then
      echo "$num:$technology:$title:$diff"
    fi
  done
}

# Main menu - Browse by
draw_browse_menu() {
  local selected=$1
  
  show_logo
  
  echo -e "${ORANGE}${BOLD}BROWSE BY${NC}"
  echo ""
  
  local options=("Difficulty" "Category")
  
  for i in "${!options[@]}"; do
    if [ $i -eq $selected ]; then
      echo -e "  ${ORANGE}▶ ${BOLD}${options[$i]}${NC}"
    else
      echo -e "  ${GRAY}${options[$i]}${NC}"
    fi
  done
  
  echo ""
  echo -e "${DIM}─────────────────────────────────────────${NC}"
  echo -e "${GRAY}↑/↓${NC} Navigate  ${GRAY}Enter${NC} Select  ${GRAY}q${NC} Quit"
}

# Difficulty selection menu
draw_difficulty_menu() {
  local selected=$1
  
  show_logo
  
  echo -e "${ORANGE}${BOLD}SELECT DIFFICULTY${NC}"
  echo ""
  
  local difficulties=("Beginner" "Intermediate" "Advanced")
  
  for i in "${!difficulties[@]}"; do
    if [ $i -eq $selected ]; then
      echo -e "  ${ORANGE}▶ ${BOLD}${difficulties[$i]}${NC}"
    else
      echo -e "  ${GRAY}${difficulties[$i]}${NC}"
    fi
  done
  
  echo ""
  echo -e "${DIM}─────────────────────────────────────────${NC}"
  echo -e "${GRAY}↑/↓${NC} Navigate  ${GRAY}Enter${NC} Select  ${GRAY}b${NC} Back  ${GRAY}q${NC} Quit"
}

# Technology selection menu
draw_technology_menu() {
  local selected=$1
  
  show_logo
  
  echo -e "${ORANGE}${BOLD}SELECT CATEGORY${NC}"
  echo ""
  
  local technologies=("Kubernetes" "Kafka" "Deployment" "Terraform" "Observability" "SRE")
  
  for i in "${!technologies[@]}"; do
    if [ $i -eq $selected ]; then
      echo -e "  ${ORANGE}▶ ${BOLD}${technologies[$i]}${NC}"
    else
      echo -e "  ${GRAY}${technologies[$i]}${NC}"
    fi
  done
  
  echo ""
  echo -e "${DIM}─────────────────────────────────────────${NC}"
  echo -e "${GRAY}↑/↓${NC} Navigate  ${GRAY}Enter${NC} Select  ${GRAY}b${NC} Back  ${GRAY}q${NC} Quit"
}

# Incident list menu
draw_incident_menu() {
  local selected=$1
  shift
  local incidents=("$@")
  
  show_logo
  
  echo -e "${ORANGE}${BOLD}SELECT INCIDENT${NC}"
  echo ""
  
  for i in "${!incidents[@]}"; do
    IFS=':' read -r num tech title difficulty <<< "${incidents[$i]}"
    local tech_display=$(echo $tech | awk '{print toupper(substr($0,1,1)) tolower(substr($0,2))}')
    
    if [ $i -eq $selected ]; then
      echo -e "  ${ORANGE}▶ ${BOLD}$num - $tech_display - $title - $difficulty${NC}"
    else
      echo -e "  ${GRAY}$num - $tech_display - $title - $difficulty${NC}"
    fi
    [ $i -lt $((${#incidents[@]} - 1)) ] && echo ""
  done
  
  echo ""
  echo -e "${DIM}─────────────────────────────────────────${NC}"
  echo -e "${GRAY}↑/↓${NC} Navigate  ${GRAY}Enter${NC} Select  ${GRAY}b${NC} Back  ${GRAY}q${NC} Quit"
}

# Action menu
draw_action_menu() {
  local selected=$1
  local incident_num=$2
  local incident_title=$3
  local category=$4
  
  show_logo
  
  echo -e "${ORANGE}${BOLD}Incident $incident_num${NC}"
  echo -e "${WHITE}$incident_title${NC}"
  echo ""
  
  local actions=("Setup" "Verify" "Teardown" "Instructions" "Hints")
  
  for i in "${!actions[@]}"; do
    if [ $i -eq $selected ]; then
      echo -e "  ${ORANGE}▶ ${BOLD}${actions[$i]}${NC}"
    else
      echo -e "  ${GRAY}${actions[$i]}${NC}"
    fi
  done
  
  echo ""
  echo -e "${DIM}─────────────────────────────────────────${NC}"
  echo -e "${GRAY}↑/↓${NC} Navigate  ${GRAY}Enter${NC} Select  ${GRAY}b${NC} Back  ${GRAY}q${NC} Quit"
}

# Run action
# Check incident dependencies
check_incident_deps() {
  local category=$1
  local incident_num=$2
  
  # Determine what's needed
  local needs_lima=false
  local needs_kind=false
  
  case $category in
    kubernetes)
      needs_kind=true
      ;;
    kafka|deployment|terraform|observability)
      needs_lima=true
      ;;
  esac
  
  # Check Kind
  if [ "$needs_kind" = true ] && ! command -v kind &> /dev/null; then
    clear
    echo -e "${ORANGE}This incident requires Kind (Kubernetes in Docker).${NC}"
    echo ""
    echo -e "${GRAY}Would you like to install Kind? (y/n)${NC}"
    read -rsn1 choice
    
    case $choice in
      'y'|'Y')
        echo ""
        echo -e "${ORANGE}Installing Kind...${NC}"
        if command -v brew &> /dev/null; then
          brew install kind
          echo ""
          echo -e "${ORANGE}Kind installed!${NC}"
          sleep 1
        else
          echo ""
          echo -e "${ORANGE}Install manually: brew install kind${NC}"
          return 1
        fi
        ;;
      *)
        return 1
        ;;
    esac
  fi
  
  # Check Lima
  if [ "$needs_lima" = true ]; then
    if ! command -v limactl &> /dev/null; then
      clear
      echo -e "${ORANGE}This incident requires Lima for VM scenarios.${NC}"
      echo ""
      echo -e "${GRAY}Would you like to install Lima? (y/n)${NC}"
      read -rsn1 choice
      
      case $choice in
        'y'|'Y')
          echo ""
          echo -e "${ORANGE}Installing Lima...${NC}"
          if command -v brew &> /dev/null; then
            brew install lima
            echo ""
            echo -e "${ORANGE}Lima installed!${NC}"
            sleep 1
          else
            echo ""
            echo -e "${ORANGE}Install manually: brew install lima${NC}"
            return 1
          fi
          ;;
        *)
          return 1
          ;;
      esac
    fi
    
    # Check socket_vmnet for multi-VM scenarios
    if [[ "$category" == "kafka" ]]; then
      if ! brew list socket_vmnet &>/dev/null; then
        clear
        echo -e "${ORANGE}Multi-VM scenarios require socket_vmnet.${NC}"
        echo ""
        echo -e "${GRAY}Would you like to install socket_vmnet? (y/n)${NC}"
        read -rsn1 choice
        
        case $choice in
          'y'|'Y')
            echo ""
            echo -e "${ORANGE}Installing socket_vmnet...${NC}"
            if command -v brew &> /dev/null; then
              brew install socket_vmnet
              echo ""
              echo -e "${ORANGE}Configuring Lima to use socket_vmnet...${NC}"
              mkdir -p ~/.lima/_config
              cat > ~/.lima/_config/override.yaml <<'EOF'
vmnet:
  socketVMNet: /opt/homebrew/opt/socket_vmnet/bin/socket_vmnet
EOF
              echo ""
              echo -e "${ORANGE}Starting socket_vmnet service (requires sudo)...${NC}"
              sudo brew services start socket_vmnet
              echo ""
              echo -e "${ORANGE}socket_vmnet installed!${NC}"
              sleep 1
            else
              echo ""
              echo -e "${ORANGE}Install manually:${NC}"
              echo "  brew install socket_vmnet"
              echo "  sudo brew services start socket_vmnet"
              return 1
            fi
            ;;
          *)
            echo ""
            echo -e "${ORANGE}Warning: Setup may fail without socket_vmnet.${NC}"
            sleep 2
            ;;
        esac
      fi
    fi
  fi
  
  return 0
}

run_action() {
  local action=$1
  local category=$2
  local incident_num=$3
  
  local incident_path="$category/incident-$incident_num"
  cd "$INSTALL_DIR/incidents/$incident_path"
  
  # Check dependencies before setup
  if [ $action -eq 0 ]; then
    if ! check_incident_deps "$category" "$incident_num"; then
      echo ""
      echo -e "${GRAY}Press any key to continue...${NC}"
      read -n 1 -s
      return
    fi
  fi
  
  clear
  case $action in
    0) # Setup
      if [ -f "setup-lima.sh" ]; then
        bash setup-lima.sh || true
      else
        bash setup.sh || true
      fi
      ;;
    1) # Verify
      if [ -f "verify-lima.sh" ]; then
        bash verify-lima.sh || true
      elif [ -f "verify.sh" ]; then
        bash verify.sh || true
      else
        echo -e "${GRAY}No verify script available${NC}"
      fi
      ;;
    2) # Teardown
      if [ -f "teardown-lima.sh" ]; then
        bash teardown-lima.sh || true
      else
        bash teardown.sh || true
      fi
      ;;
    3) # Instructions
      clear
      echo -e "${ORANGE}═══════════════════════════════════════════════════════════════════${NC}"
      echo -e "${ORANGE}  Instructions${NC}"
      echo -e "${ORANGE}═══════════════════════════════════════════════════════════════════${NC}"
      echo ""
      
      # Extract Scenario section from README
      sed -n '/## Scenario/,/## Prerequisites/p' README.md | \
      sed '$ d' | \
      sed 's/^## Scenario$//' | \
      sed 's/^$//' | \
      fold -s -w 65 | \
      sed 's/^/  /'
      
      echo ""
      echo -e "${ORANGE}─────────────────────────────────────────────────────────────────${NC}"
      echo -e "${GRAY}  Your Task:${NC}"
      echo -e "${ORANGE}─────────────────────────────────────────────────────────────────${NC}"
      echo ""
      
      # Extract Your Task section
      sed -n '/## Your Task/,/## Hints/p' README.md | \
      sed '$ d' | \
      sed 's/^## Your Task$//' | \
      sed 's/^$//' | \
      fold -s -w 65 | \
      sed 's/^/  /'
      
      ;;
    4) # Hints
      clear
      echo -e "${ORANGE}═══════════════════════════════════════════════════════════════════${NC}"
      echo -e "${ORANGE}  Hints${NC}"
      echo -e "${ORANGE}═══════════════════════════════════════════════════════════════════${NC}"
      echo ""
      
      # Extract Hints section from README
      sed -n '/## Hints/,/## Root Cause/p' README.md | \
      sed '$ d' | \
      sed 's/^## Hints$//' | \
      sed 's/^$//' | \
      fold -s -w 65 | \
      sed 's/^/  /'
      
      ;;
  esac
  
  echo ""
  echo -e "${GRAY}Press any key to continue...${NC}"
  read -n 1 -s
}

# Action menu loop
action_menu() {
  local category=$1
  local incident_num=$2
  local incident_title=$3
  local selected=0
  local max_items=3
  
  while true; do
    draw_action_menu $selected "$incident_num" "$incident_title" "$category"
    
    read -rsn1 key
    if [[ $key == $'\x1b' ]]; then
      read -rsn1 key
      if [[ $key == '[' ]]; then
        read -rsn1 key
      fi
    fi
    
    case $key in
      'A'|'k') ((selected--)); [ $selected -lt 0 ] && selected=$max_items ;;
      'B'|'j') ((selected++)); [ $selected -gt $max_items ] && selected=0 ;;
      '') run_action $selected "$category" "$incident_num" ;;
      'b'|'B') return ;;
      'q'|'Q') clear; echo -e "${ORANGE}Thanks for using Ram Ops!${NC}"; exit 0 ;;
    esac
  done
}

# Browse menu loop
browse_menu() {
  local selected=0
  local max_items=1
  
  while true; do
    draw_browse_menu $selected
    
    read -rsn1 key
    if [[ $key == $'\x1b' ]]; then
      read -rsn1 key
      if [[ $key == '[' ]]; then
        read -rsn1 key
      fi
    fi
    
    case $key in
      'A'|'k') ((selected--)); [ $selected -lt 0 ] && selected=$max_items ;;
      'B'|'j') ((selected++)); [ $selected -gt $max_items ] && selected=0 ;;
      '')
        if [ $selected -eq 0 ]; then
          difficulty_menu
        else
          technology_menu
        fi
        ;;
      'q'|'Q') clear; echo -e "${ORANGE}Thanks for using Ram Ops!${NC}"; exit 0 ;;
    esac
  done
}

# Difficulty menu loop
difficulty_menu() {
  local selected=0
  local difficulties=("Beginner" "Intermediate" "Advanced")
  local max_items=$((${#difficulties[@]} - 1))
  
  while true; do
    draw_difficulty_menu $selected
    
    read -rsn1 key
    if [[ $key == $'\x1b' ]]; then
      read -rsn1 key
      if [[ $key == '[' ]]; then
        read -rsn1 key
      fi
    fi
    
    case $key in
      'A'|'k') ((selected--)); [ $selected -lt 0 ] && selected=$max_items ;;
      'B'|'j') ((selected++)); [ $selected -gt $max_items ] && selected=0 ;;
      '')
        local incidents=()
        while IFS= read -r line; do
          incidents+=("$line")
        done < <(get_incidents_by_difficulty "${difficulties[$selected]}")
        if [ ${#incidents[@]} -gt 0 ]; then
          incident_menu "${incidents[@]}"
        fi
        ;;
      'b'|'B') return ;;
      'q'|'Q') clear; echo -e "${ORANGE}Thanks for using Ram Ops!${NC}"; exit 0 ;;
    esac
  done
}

# Technology menu loop
technology_menu() {
  local selected=0
  local technologies=("kubernetes" "kafka" "deployment" "terraform" "observability" "sre")
  local max_items=$((${#technologies[@]} - 1))
  
  while true; do
    draw_technology_menu $selected
    
    read -rsn1 key
    if [[ $key == $'\x1b' ]]; then
      read -rsn1 key
      if [[ $key == '[' ]]; then
        read -rsn1 key
      fi
    fi
    
    case $key in
      'A'|'k') ((selected--)); [ $selected -lt 0 ] && selected=$max_items ;;
      'B'|'j') ((selected++)); [ $selected -gt $max_items ] && selected=0 ;;
      '')
        local incidents=()
        while IFS= read -r line; do
          incidents+=("$line")
        done < <(get_incidents_by_technology "${technologies[$selected]}")
        if [ ${#incidents[@]} -gt 0 ]; then
          incident_menu "${incidents[@]}"
        fi
        ;;
      'b'|'B') return ;;
      'q'|'Q') clear; echo -e "${ORANGE}Thanks for using Ram Ops!${NC}"; exit 0 ;;
    esac
  done
}

# Incident menu loop
incident_menu() {
  local incidents=("$@")
  local selected=0
  local max_items=$((${#incidents[@]} - 1))
  
  while true; do
    draw_incident_menu $selected "${incidents[@]}"
    
    read -rsn1 key
    if [[ $key == $'\x1b' ]]; then
      read -rsn1 key
      if [[ $key == '[' ]]; then
        read -rsn1 key
      fi
    fi
    
    case $key in
      'A'|'k') ((selected--)); [ $selected -lt 0 ] && selected=$max_items ;;
      'B'|'j') ((selected++)); [ $selected -gt $max_items ] && selected=0 ;;
      '')
        IFS=':' read -r num tech title difficulty <<< "${incidents[$selected]}"
        action_menu "$tech" "$num" "$title"
        ;;
      'b'|'B') return ;;
      'q'|'Q') clear; echo -e "${ORANGE}Thanks for using Ram Ops!${NC}"; exit 0 ;;
    esac
  done
}

# Main menu loop
main_menu() {
  local selected=0
  local categories=($(get_categories))
  local max_items=$((${#categories[@]} - 1))
  
  while true; do
    draw_main_menu $selected
    
    read -rsn1 key
    if [[ $key == $'\x1b' ]]; then
      read -rsn1 key
      if [[ $key == '[' ]]; then
        read -rsn1 key
      fi
    fi
    
    case $key in
      'A'|'k') ((selected--)); [ $selected -lt 0 ] && selected=$max_items ;;
      'B'|'j') ((selected++)); [ $selected -gt $max_items ] && selected=0 ;;
      '') incident_menu "${categories[$selected]}" ;;
      'q'|'Q') clear; echo -e "${ORANGE}Thanks for using Ram Ops!${NC}"; exit 0 ;;
    esac
  done
}

# Main
main() {
  # Handle update command
  if [ "${1:-}" = "update" ]; then
    do_update
  fi
  
  check_deps
  setup_repo
  browse_menu
}

main "$@"
